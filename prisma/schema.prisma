// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  password   String?
  name       String?
  skills     String[]
  experience String?
  resumeUrl  String?

  // Enhanced profile fields
  summary           String? @db.Text
  location          String?
  preferredCountries String[]  @default([])
  salaryExpectation String?
  workPreference    String?
  availability      String?

  yearsOfExperience Int?
  seniorityLevel    String?

  // Job search preferences
  minFitScore          Int?     @default(40)
  maxJobAgeDays        Int?     @default(7)
  autoScan             Boolean? @default(true)
  scanFrequency        String?  @default("daily")
  dailyApplicationGoal Int?     @default(6)

  education       String[] @default([])
  primarySkills   String[] @default([])
  secondarySkills String[] @default([])
  learningSkills  String[] @default([])

  jobTitles       String[] @default([])
  industries      String[] @default([])
  excludeKeywords String[] @default([])

  workHistory      Json?
  extractedProfile Json?
  lastExtracted    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applications  Application[]
  resumes       Resume[]
  coverLetters  CoverLetter[]
  opportunities JobOpportunity[]
  alerts        Alert[]
  blockedJobs   BlockedJob[]
  contacts      Contact[]
  followUps     FollowUp[]
  jobSources    UserJobSource[]

  @@map("users")
}

model Application {
  id          String            @id @default(cuid())
  company     String
  role        String
  status      ApplicationStatus @default(DRAFT)
  notes       String?
  jobUrl      String?
  appliedDate DateTime?
  interviewDate DateTime? @map("interview_date")
  interviewTime String? @map("interview_time") // Store time separately for easier formatting
  interviewType String? @map("interview_type") // phone, video, in-person, etc.
  interviewRound Int? @default(1) @map("interview_round") // Track which round of interviews
  interviewNotes String? @map("interview_notes") @db.Text

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  resumeId String?
  resume   Resume? @relation(fields: [resumeId], references: [id], onDelete: SetNull)

  coverLetterId String? @map("cover_letter_id")
  coverLetter   CoverLetter? @relation(fields: [coverLetterId], references: [id], onDelete: SetNull)

  contacts Contact[]
  followUps FollowUp[]

  @@map("applications")
}

model Contact {
  id        String   @id @default(cuid())
  name      String
  title     String?
  email     String?
  phone     String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  applicationId String?
  application   Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  followUps FollowUp[]
  @@map("contacts")
}

enum ApplicationStatus {
  DRAFT
  PENDING
  APPLIED
  INTERVIEWING
  REJECTED
  ARCHIVED
}

model JobOpportunity {
  id           String    @id @default(cuid())
  title        String
  company      String
  description  String    @db.Text
  requirements String?   @db.Text
  location     String?
  salary       String?
  jobUrl       String    @unique
  source       String // e.g., "LinkedIn", "Indeed", "Custom"
  sourceUrl    String? // URL of the job board or RSS feed
  postedDate   DateTime?
  scrapedAt    DateTime  @default(now())
  isRead       Boolean   @default(false)
  isArchived   Boolean   @default(false)
  deletedAt    DateTime?
  fitScore     Float?
  userFeedback String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  alerts Alert[]

  @@map("job_opportunities")
}

model Alert {
  id        String    @id @default(cuid())
  message   String
  type      AlertType @default(NEW_JOB)
  isRead    Boolean   @default(false)
  createdAt DateTime  @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  opportunityId String?
  opportunity   JobOpportunity? @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@map("alerts")
}

enum AlertType {
  NEW_JOB
  APPLICATION_UPDATE
  REMINDER
}

model Resume {
  id          String  @id @default(cuid())
  name        String // e.g., Software Engineer Resume, Security Resume
  fileName    String // Original filename
  fileUrl     String // URL to stored resume file
  fileType    String // e.g., application/pdf
  fileSize    Int // File size in bytes
  isPrimary   Boolean @default(false)
  description String? @db.Text // Optional notes about this resume

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  applications Application[]
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("resumes")
}


model CoverLetter {
  @@map("cover_letters")
  id          String  @id @default(cuid())
  name        String // e.g., Cover Letter for Software Engineer at Company
  fileName    String @map("file_name") // Original filename
  fileUrl     String @map("file_url") // URL to stored cover letter file
  fileType    String @map("file_type") // e.g., application/vnd.openxmlformats-officedocument.wordprocessingml.document
  fileSize    Int @map("file_size") // File size in bytes
  description String? @db.Text // Optional notes about this cover letter
  content     String? @db.Text // The actual cover letter text content

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  applications Application[]

}


model FollowUp {
  id          String   @id @default(cuid())
  title       String   // e.g., "Thank interviewer", "Check application status"
  description String?  @db.Text // Additional details about the follow-up
  dueDate     DateTime @map("due_date") // When the follow-up is due
  completed   Boolean  @default(false)
  completedAt DateTime? @map("completed_at")
  priority    String   @default("medium") // low, medium, high
  type        String   @default("general") // interview, application, networking, general
  
  // Notification settings
  notifyBefore Int      @default(24) @map("notify_before") // Hours before due date to notify
  notified     Boolean  @default(false)
  notifiedAt   DateTime? @map("notified_at")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  applicationId String? @map("application_id")
  application   Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  contactId String? @map("contact_id")
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  @@map("follow_ups")
  @@index([userId, dueDate])
  @@index([userId, completed])
}

model BlockedJob {
  id        String   @id @default(cuid())
  jobUrl    String
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, jobUrl])
  @@map("blocked_jobs")
}

model UserJobSource {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Source types: "rss", "web_scrape", "api", "job_board"
  sourceType String

  // Configuration based on source type
  feedUrl        String? // For RSS feeds
  scrapeUrl      String? // For web scraping
  scrapeSelector String? // CSS selector for job listings container
  apiEndpoint    String? // API endpoint URL
  apiKey         String? // API key if needed
  apiHeaders     Json? // Custom headers for API requests

  // Filtering and parsing config
  titleSelector       String? // CSS selector for job title
  companySelector     String? // CSS selector for company name
  locationSelector    String? // CSS selector for location
  linkSelector        String? // CSS selector for job link
  descriptionSelector String? // CSS selector for job description

  // Advanced options
  enabled          Boolean  @default(true)
  isBuiltIn        Boolean  @default(false)
  rateLimitPerHour Int?     @default(100)
  searchKeywords   String[] @default([]) // Keywords to search for
  excludeKeywords  String[] @default([]) // Keywords to exclude

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_job_sources")
}
